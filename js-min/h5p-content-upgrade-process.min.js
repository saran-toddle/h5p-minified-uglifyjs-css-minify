var H5PUpgrades=H5PUpgrades||{};H5P.ContentUpgradeProcess=function(r){function n(r,n,e,o,t,a,i){try{if(!((o=JSON.parse(o))instanceof Object))throw!0}catch(r){return i({type:"errorParamsBroken",id:t})}this.loadLibrary=a,this.upgrade(r,n,e,o.params,o.metadata,(function(r,n,e){if(r)return r.id=t,i(r);i(null,JSON.stringify({params:n,metadata:e}))}))}n.prototype.upgrade=function(r,n,o,t,a,i){var s=this;s.loadLibrary(r,o,(function(r,c){return r?i(r):null===c.semantics?i({type:"libraryMissing",library:c.name+" "+c.version.major+"."+c.version.minor}):void s.processParams(c,n,o,t,a,(function(r,n,o){if(r)return i(r);e(c.semantics,(function(r,e,o){s.processField(e,n[e.name],(function(r,t){t&&(n[e.name]=t),o(r)}))}),(function(r){i(r,n,o)}))}))}))},n.prototype.processParams=function(r,n,o,t,a,i){if(void 0===H5PUpgrades[r.name])return r.upgradesScript?i({type:"scriptMissing",library:r.name+" "+o}):i(null,t,a);e(H5PUpgrades[r.name],(function(r,s,c){r<n.major||r>o.major?c():e(s,(function(r,e,s){if((r=+r)<=n.minor||r>o.minor)s();else{var c=void 0!==e.contentUpgrade?e.contentUpgrade:e;try{c(t,(function(r,n,e){t=n,e&&e.metadata&&(a=e.metadata),s(r)}),{metadata:a})}catch(r){console&&console.error&&(console.error("Error",r.stack),console.error("Error",r.name),console.error("Error",r.message)),i(r)}}}),c)}),(function(r){i(r,t,a)}))},n.prototype.processField=function(n,o,t){var a=this;if(void 0===o)return t();switch(n.type){case"library":if(void 0===o.library||void 0===o.params)return t();for(var i=o.library.split(" ",2),s=0;s<n.options.length;s++){var c="string"==typeof n.options[s]?n.options[s].split(" ",2):n.options[s].name.split(" ",2);if(c[0]===i[0]){if(c[1]===i[1])return t();var u=new r(i[1]),p=new r(c[1]);return u.major>p.major||u.major===p.major&&u.minor>=p.minor?t({type:"errorTooHighVersion",used:i[0]+" "+u,supported:c[0]+" "+p}):a.upgrade(c[0],u,p,o.params,o.metadata,(function(r,n,e){r||(o.library=c[0]+" "+p.major+"."+p.minor,o.params=n,e&&(o.metadata=e)),t(r,o)}))}}t({type:"errorNotSupported",used:i[0]+" "+u});break;case"group":1===n.fields.length&&!0!==n.isSubContent?a.processField(n.fields[0],o,(function(r,n){n&&(o=n),t(r,o)})):e(n.fields,(function(r,n,e){var t=o?o[n.name]:null;a.processField(n,t,(function(r,t){t&&(o[n.name]=t),e(r)}))}),(function(r){t(r,o)}));break;case"list":e(o,(function(r,e,t){a.processField(n.field,e,(function(n,e){e&&(o[r]=e),t(n)}))}),(function(r){t(r,o)}));break;default:t()}};var e=function(r,n,e){var o,t=r instanceof Array;if(!t){var a=[];for(o in r)r.hasOwnProperty(o)&&a.push(o)}var i=-1,s=function(c){setTimeout((function(){++i===(t?r.length:a.length)||null!=c?e(c):(o=t?i:a[i],n(o,r[o],s))}),0)};s()};return n}(H5P.Version);