var H5PDataView=function(t){function e(e,a,o,n,r,i,s,l){var c=this;c.$container=t(e).addClass("h5p-data-view").html(""),c.source=a,c.headers=o,c.l10n=n,c.classes=void 0===r?{}:r,c.filters=void 0===i?[]:i,c.loaded=s,c.order=l,c.limit=20,c.offset=0,c.filterOn=[],c.facets={},c.columnIdAuthor=2,H5PIntegration.user&&1===parseInt(H5PIntegration.user.canToggleViewOthersH5PContents)?(c.updateTable([]),c.filterByFacet(c.columnIdAuthor,H5PIntegration.user.id,H5PIntegration.user.name||"")):c.loadData()}return e.prototype.loadData=function(){var e=this;e.setMessage(H5PUtils.throbber(e.l10n.loading));var a,o=e.source;o+=(-1===o.indexOf("?")?"?":"&")+"offset="+e.offset+"&limit="+e.limit,void 0!==e.order&&(o+="&sortBy="+e.order.by+"&sortDir="+e.order.dir);for(var n=0;n<e.filterOn.length;n++)void 0!==e.filterOn[n]&&(a=!0,o+="&filters["+n+"]="+encodeURIComponent(e.filterOn[n]));for(var r in e.facets)e.facets.hasOwnProperty(r)&&(o+="&facets["+r+"]="+e.facets[r].id);t.ajax({dataType:"json",cache:!0,url:o}).fail((function(){e.setMessage(t("<p/>",{text:e.l10n.ajaxFailed}))})).done((function(o){o.rows.length?e.updateTable(o.rows):e.setMessage(t("<p/>",{text:a?e.l10n.noData:e.l10n.empty})),e.updatePagination(o.num),void 0!==e.loaded&&e.loaded()}))},e.prototype.setMessage=function(t){var e=this;void 0===e.table?e.$container.html("").append(t):e.table.setBody(t)},e.prototype.updateTable=function(e){var a=this;void 0===a.table&&(a.$container.html(""),a.addFilters(),H5PIntegration.user&&parseInt(H5PIntegration.user.canToggleViewOthersH5PContents)>0&&a.addOthersContentToggler(1===parseInt(H5PIntegration.user.canToggleViewOthersH5PContents)),a.$facets=t("<div/>",{class:"h5p-facet-wrapper",appendTo:a.$container}),a.table=new H5PUtils.Table(a.classes,a.headers),a.table.setHeaders(a.headers,(function(t){a.order=t,a.loadData()}),a.order),a.table.appendTo(a.$container));for(var o=0;o<a.headers.length;o++)if(!0===a.headers[o].facet)for(var n=0;n<e.length;n++)e[n][o]=a.createFacets(e[n][o],o);var r=a.table.setRows(e);t(".h5p-facet",r).click((function(){var e=t(this);a.filterByFacet(e.data("col"),e.data("id"),e.text())})).keypress((function(e){if(32===e.which){var o=t(this);a.filterByFacet(o.data("col"),o.data("id"),o.text())}}))},e.prototype.createFacets=function(t,e){var a="";if(t instanceof Array)for(var o=0;o<t.length;o++)""!==a&&(a+=", "),a+='<span class="h5p-facet" role="button" tabindex="0" data-id="'+t[o].id+'" data-col="'+e+'">'+t[o].title+"</span>";else a+='<span class="h5p-facet" role="button" tabindex="0" data-id="'+t.id+'" data-col="'+e+'">'+t.title+"</span>";return""===a?"â€”":a},e.prototype.filterByFacet=function(e,a,o){var n=this;if(void 0!==n.facets[e]){if(n.facets[e].id===a)return;n.facets[e].$tag.remove()}n.facets[e]={id:a,$tag:t("<span/>",{class:"h5p-facet-tag",text:o,appendTo:n.$facets})};var r=function(){n.$othersContentToggler&&n.facets.hasOwnProperty(n.columnIdAuthor)&&n.$othersContentToggler.prop("checked",!1),n.facets[e].$tag.remove(),delete n.facets[e],n.loadData()};t("<span/>",{role:"button",tabindex:0,appendTo:n.facets[e].$tag,text:n.l10n.remove,title:n.l10n.remove,on:{click:r,keypress:function(t){32===t.which&&r()}}}),n.loadData()},e.prototype.updatePagination=function(e){var a=this;if(void 0===a.pagination){if(void 0===a.table)return;var o=t("<div/>",{class:"h5p-pagination"});a.pagination=new H5PUtils.Pagination(e,a.limit,(function(t){a.offset=t,a.loadData()}),a.l10n),a.pagination.appendTo(o),a.table.setFoot(o)}else a.pagination.update(e,a.limit)},e.prototype.addFilters=function(){for(var t=this,e=0;e<t.filters.length;e++)!0===t.filters[e]&&t.addTextFilter(e)},e.prototype.addTextFilter=function(e){var a,o=this,n=function(){var t=r.val().replace(/^\s+|\s+$/g,"");""===t&&(t=void 0),t!==o.filterOn[e]&&(o.filterOn[e]=t,o.loadData())},r=t("<input/>",{type:"text",placeholder:o.l10n.search,on:{blur:function(){clearTimeout(a),n()},keyup:function(t){if(13===t.keyCode)return clearTimeout(a),n(),!1;clearTimeout(a),a=setTimeout((function(){n()}),500)}}}).appendTo(o.$container)},e.prototype.addOthersContentToggler=function(e){var a=this;e=void 0!==e&&e,this.$othersContentToggler=t("<input/>",{type:"checkbox",class:"h5p-others-contents-toggler",id:"h5p-others-contents-toggler",checked:e,click:function(){this.checked?a.filterByFacet(a.columnIdAuthor,H5PIntegration.user.id,H5PIntegration.user.name):(a.facets.hasOwnProperty(a.columnIdAuthor)&&a.facets[a.columnIdAuthor].$tag&&a.facets[a.columnIdAuthor].$tag.remove(),delete a.facets[a.columnIdAuthor],a.loadData())}});var o=t("<label>",{class:"h5p-others-contents-toggler-label",text:this.l10n.showOwnContentOnly,for:"h5p-others-contents-toggler"}).prepend(this.$othersContentToggler);t("<div>",{class:"h5p-others-contents-toggler-wrapper"}).append(o).appendTo(this.$container)},e}(H5P.jQuery);