H5P.RequestQueue=function(e,t){const n=function(e){t.call(this),this.processingQueue=!1,e=e||{},this.showToast=e.showToast,this.itemName="requestQueue"};return n.prototype.add=function(e,t){if(!window.localStorage)return!1;let n=this.getStoredRequests();return n||(n=[]),n.push({url:e,data:t}),window.localStorage.setItem(this.itemName,JSON.stringify(n)),this.trigger("requestQueued",{storedStatements:n,processingQueue:this.processingQueue}),!0},n.prototype.getStoredRequests=function(){if(!window.localStorage)return!1;const e=window.localStorage.getItem(this.itemName);return e?JSON.parse(e):[]},n.prototype.clearQueue=function(){return!!window.localStorage&&(window.localStorage.removeItem(this.itemName),!0)},n.prototype.resumeQueue=function(){if(!H5PIntegration||!window.navigator||!window.localStorage)return!1;if(this.processingQueue)return!1;const e=this.getStoredRequests(),t=e.length;return this.clearQueue(),t?(this.processingQueue=!0,this.processQueue(e),!0):(this.trigger("emptiedQueue",e),!0)},n.prototype.processQueue=function(t){if(!t.length)return;this.trigger("processingQueue");const n=t.shift(),o=this;e.post(n.url,n.data).fail(o.onQueuedRequestFail.bind(o,n)).always(o.onQueuedRequestProcessed.bind(o,t))},n.prototype.onQueuedRequestFail=function(e){window.navigator.onLine||this.add(e.url,e.data)},n.prototype.onQueuedRequestProcessed=function(e){if(e.length)return void this.processQueue(e);this.processingQueue=!1;const t=this.getStoredRequests();this.trigger("queueEmptied",t)},n.prototype.displayToastMessage=function(e,t,n){if(!this.showToast&&!t)return;const o=H5P.jQuery.extend(!0,{},{position:{horizontal:"centered",vertical:"centered",noOverflowX:!0}},n);H5P.attachToastTo(H5P.jQuery(".h5p-content:first")[0],e,o)},n}(H5P.jQuery,H5P.EventDispatcher),H5P.OfflineRequestQueue=function(e,t){return function(n){const o=new e;o.clearQueue();let i=null;const s=[10,20,40,60,120,300,600];let u=-1,r=null,a=!1,c=!1,d=!1;const l=n.instance,h=new t({headerText:H5P.t("offlineDialogHeader"),dialogText:H5P.t("offlineDialogBody"),confirmText:H5P.t("offlineDialogRetryButtonLabel"),hideCancel:!0,hideExit:!0,classes:["offline"],instance:l,skipRestoreFocus:!0}),f=h.getElement(),p=document.createElement("div");p.classList.add("count-down"),p.innerHTML=H5P.t("offlineDialogRetryMessage").replace(":num",'<span class="count-down-num">0</span>'),f.querySelector(".h5p-confirmation-dialog-text").appendChild(p);const g=p.querySelector(".count-down-num"),w=document.createElement("div");w.classList.add("throbber-wrapper");const m=document.createElement("div");m.classList.add("sending-requests-throbber"),w.appendChild(m),o.on("requestQueued",function(e){if(!e.data||!e.data.processingQueue){if(!a){const e=document.body.querySelector(".h5p-content");if(!e)return;h.appendTo(e),e.appendChild(w),a=!0}y()}}.bind(this)),o.on("queueEmptied",function(e){e.data&&e.data.length?y(!0):(clearInterval(r),Q(!1),u=-1,c&&(h.hide(),c=!1),o.displayToastMessage(H5P.t("offlineSuccessfulSubmit"),!0,{position:{vertical:"top",offsetVertical:"100"}}))}.bind(this)),h.on("confirmed",function(){c=!1,setTimeout((function(){q()}),100)}.bind(this)),window.addEventListener("online",function(){q()}.bind(this)),window.addEventListener("message",function(e){window.parent===e.source&&"h5p"===e.data.context&&"queueRequest"===e.data.action&&this.add(e.data.url,e.data.data)}.bind(this));const Q=function(e){d=!d,void 0!==e&&(d=e),d&&c&&(h.hide(),c=!1),d?w.classList.add("show"):w.classList.remove("show")},q=function(){clearInterval(r),Q(!0),o.resumeQueue()},y=function(e){c||(Q(!1),c||(e?setTimeout((function(){h.show(0)}),100):h.show(0)),c=!0,i=(new Date).getTime(),u+=1,u>=s.length&&(u=s.length-1),clearInterval(r),r=setInterval(v,100))},v=function(){const e=(new Date).getTime(),t=Math.floor((e-i)/1e3),n=s[u]-t;g.textContent=n.toString(),n<=0&&q()};this.add=function(e,t){if(window.navigator.onLine)return!1;o.add(e,t)}}}(H5P.RequestQueue,H5P.ConfirmationDialog);